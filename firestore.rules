rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Funciones auxiliares para roles
    function isAuthenticated() {
      return request.auth != null;
    }

    function getUserRole() {
      return request.auth.token.role;
    }

    // Roles principales
    function isSuperAdmin() {
      return isAuthenticated() && getUserRole() == 'superadmin';
    }

    function isCoordinacion() {
      return isAuthenticated() && getUserRole() == 'coordinacion';
    }

    function isDocente() {
      return isAuthenticated() && getUserRole() == 'docente';
    }

    function isTallerista() {
      return isAuthenticated() && getUserRole() == 'tallerista';
    }

    function isFamily() {
      return isAuthenticated() && getUserRole() == 'family';
    }

    // Roles administrativos (SuperAdmin y Coordinación)
    function isAdmin() {
      return isSuperAdmin() || isCoordinacion();
    }

    // Permisos específicos
    function canSendCommunications() {
      // SuperAdmin, Coordinación, Docentes (NO talleristas)
      return isAuthenticated() && getUserRole() in ['superadmin', 'coordinacion', 'docente'];
    }

    function canManageAppointments() {
      // Solo SuperAdmin y Coordinación (Emilse, Camila, Rosana)
      return isSuperAdmin() || isCoordinacion();
    }

    function canManageTalleres() {
      // SuperAdmin y Coordinación
      return isAdmin();
    }

    function canUploadDocuments() {
      // SuperAdmin, Coordinación, Docentes, Talleristas
      return isAuthenticated() && getUserRole() in ['superadmin', 'coordinacion', 'docente', 'tallerista'];
    }

    function canCreateEvents() {
      // SuperAdmin, Coordinación, Docentes
      return canSendCommunications();
    }

    function isConversationFamily(conv) {
      return isFamily() && request.auth.uid == conv.familiaUid;
    }

    function isConversationSchool(conv) {
      return isSuperAdmin() || (isCoordinacion() && conv.destinatarioEscuela == 'coordinacion');
    }

    function isConversationParticipant(conv) {
      return isConversationFamily(conv) || isConversationSchool(conv);
    }

    // Colección: /users (perfiles de usuarios)
    match /users/{userId} {
      // Leer: Usuario puede ver su propio perfil, admin puede ver todos, 
      // familias pueden ver otros responsables de sus hijos
      allow read: if isAuthenticated() && (
        request.auth.uid == userId ||
        isAdmin() ||
        (isFamily() && resource.data.role == 'family')
      );

      // Crear/Actualizar: Solo admin puede crear usuarios o el propio usuario puede actualizar ciertos campos
      allow create: if isAdmin();
      allow update: if isAdmin() || (
        request.auth.uid == userId &&
        !request.resource.data.diff(resource.data).affectedKeys().hasAny(['role', 'children'])
      );

      // Eliminar: Solo admin
      allow delete: if isAdmin();
    }

    // Colección: /children (fichas de alumnos)
    match /children/{childId} {
      // Leer: Admin ve todos, familias pueden leer (filtrado por query array-contains), docentes ven alumnos de su ambiente
      // NOTA: No podemos validar array-contains en security rules, el filtrado lo hace la query
      allow read: if isAuthenticated() && (
        isAdmin() ||
        isFamily() ||
        (isDocente() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.tallerAsignado == resource.data.ambiente)
      );

      // Crear/Actualizar/Eliminar: Solo admin
      allow create, update, delete: if isAdmin();
    }

    // Colección: /communications (comunicados)
    match /communications/{commId} {
      // Leer: Admin o si el usuario está en destinatarios[]
      allow read: if isAuthenticated() && (
        isAdmin() ||
        request.auth.uid in resource.data.destinatarios
      );

      // Crear: SuperAdmin, Coordinación, Docentes (NO talleristas)
      allow create: if canSendCommunications();

      // Actualizar: Admin puede todo, o el creador puede editar (si no está aprobado)
      allow update: if isAdmin() || (
        resource.data.sentBy == request.auth.uid &&
        (!exists(/databases/$(database)/documents/communications/$(commId)) ||
         !resource.data.keys().hasAny(['aprobado']) ||
         resource.data.aprobado == false)
      );

      // Eliminar: Solo SuperAdmin
      allow delete: if isSuperAdmin();

      // Subcolección: lecturas (confirmaciones de lectura)
      match /lecturas/{userId} {
        // Crear: El propio usuario marca su lectura
        allow create: if isAuthenticated() && request.auth.uid == userId;

        // Leer: Admin o el propio usuario
        allow read: if isAuthenticated() && (isAdmin() || request.auth.uid == userId);

        // No se puede actualizar ni eliminar
        allow update, delete: if false;
      }
    }

    // Colección: /conversations (conversaciones privadas)
    match /conversations/{convId} {
      allow read: if isAuthenticated() && isConversationParticipant(resource.data);

      // Crear: familia crea su consulta o admin/coordinación crea mensaje
      allow create: if isAuthenticated() && (
        (isFamily() && request.resource.data.familiaUid == request.auth.uid) ||
        (isAdmin() && request.resource.data.iniciadoPor == 'escuela')
      );

      // Actualizar: admin/coordinación (según área) o familia participante
      allow update: if (isAdmin() && isConversationSchool(resource.data)) || (
        isFamily() &&
        request.auth.uid == resource.data.familiaUid &&
        resource.data.estado != 'cerrada' &&
        !request.resource.data.diff(resource.data).affectedKeys().hasAny([
          'familiaUid',
          'familiaDisplayName',
          'familiaEmail',
          'destinatarioEscuela',
          'categoria',
          'asunto',
          'iniciadoPor',
          'creadoAt',
          'cerradoAt',
          'cerradoPor',
          'reasignadoAt'
        ])
      );

      // Eliminar: solo superadmin
      allow delete: if isSuperAdmin();

      // Subcolección: mensajes
      match /messages/{messageId} {
        allow read: if isAuthenticated() &&
          isConversationParticipant(get(/databases/$(database)/documents/conversations/$(convId)).data);

        allow create: if isAuthenticated() &&
          isConversationParticipant(get(/databases/$(database)/documents/conversations/$(convId)).data) &&
          request.resource.data.autorUid == request.auth.uid &&
          get(/databases/$(database)/documents/conversations/$(convId)).data.estado != 'cerrada';

        allow update, delete: if false;
      }
    }

    // Colección: /events (calendario de eventos)
    match /events/{eventId} {
      // Leer: todos los usuarios autenticados (para el calendario del sidebar)
      allow read: if isAuthenticated();

      // Crear: roles que pueden enviar comunicados
      allow create: if canCreateEvents();

      // Actualizar/Eliminar: solo admin
      allow update, delete: if isAdmin();
    }

    // Colección: /appointments (turnos - Fase 3)
    match /appointments/{appointmentId} {
      // Leer: Admin ve todos, familias ven todos (incluye disponibles y sus propios turnos)
      allow read: if isAuthenticated() && (
        isAdmin() ||
        isFamily()
      );

      // Crear: Solo SuperAdmin y Coordinación (Emilse, Camila, Rosana)
      allow create: if canManageAppointments();

      // Actualizar: Admin puede todo, familias solo reservar disponibles o cancelar sus turnos
      allow update: if canManageAppointments() || (
        isFamily() && (
          (resource.data.estado == 'disponible' && request.resource.data.familiaUid == request.auth.uid && request.resource.data.estado == 'reservado') ||
          ((resource.data.familiaUid == request.auth.uid || request.auth.uid in resource.data.get('familiasUids', [])) && request.resource.data.estado == 'cancelado')
        )
      );

      // Eliminar: Solo SuperAdmin y Coordinación
      allow delete: if canManageAppointments();
    }

    // Colección: /documents (documentos institucionales - Fase 5)
    match /documents/{docId} {
      // Leer: Usuarios autenticados si su rol está en roles[] o si es admin
      allow read: if isAuthenticated() && (
        isAdmin() ||
        getUserRole() in resource.data.roles
      );

      // Crear: Admin, Coordinación, Docentes, Talleristas
      allow create: if canUploadDocuments();

      // Actualizar: Admin puede todo, otros solo sus propios documentos
      allow update: if isAdmin() || (
        canUploadDocuments() &&
        resource.data.uploadedBy == request.auth.uid
      );

      // Eliminar: Solo SuperAdmin y Coordinación
      allow delete: if isAdmin();
    }

    // Colección: /talleres (talleres especiales - Fase 5)
    match /talleres/{tallerId} {
      // Leer: Todos los autenticados pueden ver talleres activos
      allow read: if isAuthenticated();

      // Crear: Solo SuperAdmin y Coordinación
      allow create: if canManageTalleres();

      // Actualizar: Admin o el tallerista asignado puede actualizar
      allow update: if canManageTalleres() || (
        isTallerista() &&
        request.auth.uid in resource.data.talleristaId
      );

      // Eliminar: Solo SuperAdmin y Coordinación
      allow delete: if canManageTalleres();

      // Subcolección: /talleres/{tallerId}/gallery (fotos y videos)
      match /gallery/{mediaId} {
        // Leer: Todos los autenticados
        allow read: if isAuthenticated();

        // Crear/Actualizar: Admin o tallerista del taller
        allow create, update: if isAdmin() || (
          isAuthenticated() &&
          request.auth.uid in get(/databases/$(database)/documents/talleres/$(tallerId)).data.talleristaId
        );

        // Eliminar: Admin o quien lo subió
        allow delete: if isAdmin() || (
          isAuthenticated() &&
          resource.data.uploadedBy == request.auth.uid
        );
      }
    }

    // Colección: /aspirantes (aspirantes - Fase 5)
    match /aspirantes/{aspiranteId} {
      allow read: if isAuthenticated() && (
        isAdmin() ||
        request.auth.uid == aspiranteId
      );
      allow write: if isAdmin();
    }

    // Colección: /snackAssignments (calendario de snacks)
    match /snackAssignments/{assignmentId} {
      // Leer: Admin ve todos, familias solo sus propias asignaciones
      // Soporta tanto el modelo viejo (familiaUid) como el nuevo (familiasUids array)
      allow read: if isAuthenticated() && (
        isAdmin() ||
        (isFamily() && (
          resource.data.familiaUid == request.auth.uid ||
          request.auth.uid in resource.data.get('familiasUids', [])
        ))
      );

      // Crear/Eliminar: Solo SuperAdmin y Coordinación
      allow create, delete: if isAdmin();

      // Actualizar: Admin puede todo, familias solo pueden confirmar, solicitar cambio o cancelar
      allow update: if isAdmin() || (
        isFamily() &&
        (resource.data.familiaUid == request.auth.uid || request.auth.uid in resource.data.get('familiasUids', [])) &&
        (
          // Permitir confirmar (modelo viejo - confirmadoPorFamilia)
          (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['confirmadoPorFamilia', 'estado', 'solicitudCambio', 'motivoCambio', 'fechaConfirmacion', 'updatedAt']) &&
           request.resource.data.confirmadoPorFamilia == true) ||
          // Permitir solicitar cambio
          (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['solicitudCambio', 'motivoCambio', 'confirmadoPorFamilia', 'estado', 'fechaSolicitudCambio', 'updatedAt']) &&
           request.resource.data.solicitudCambio == true) ||
          // Permitir cancelar turno
          (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['estado', 'motivoCancelacion', 'confirmadoPorFamilia', 'fechaCancelacion', 'updatedAt']) &&
           request.resource.data.estado == 'cancelado') ||
          // Permitir confirmación por familia (modelo nuevo - actualizar array familias)
          request.resource.data.diff(resource.data).affectedKeys().hasOnly(['familias', 'estado', 'confirmadoPorFamilia', 'confirmadoPor', 'updatedAt'])
        )
      );
    }

    // Colección: /snackLists (listas de snacks por ambiente)
    match /snackLists/{ambiente} {
      // Leer: Todos los autenticados pueden ver las listas
      allow read: if isAuthenticated();

      // Crear/Actualizar: Solo SuperAdmin y Coordinación
      allow create, update: if isAdmin();

      // Eliminar: Solo SuperAdmin
      allow delete: if isSuperAdmin();
    }

    // Por defecto, denegar todo lo demás
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
